#!/bin/bash
# sync-frontend-env.sh - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒå¤‰æ•°åŒæœŸã‚³ãƒãƒ³ãƒ‰

# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿
source "${SCRIPT_DIR}/lib/logging.sh"
source "${SCRIPT_DIR}/lib/input.sh"
source "${SCRIPT_DIR}/lib/network.sh"
source "${SCRIPT_DIR}/lib/env_manager.sh"

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¨­å®š
initialize_env_manager "$SCRIPT_DIR"

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹
FRONTEND_DIR="$(cd "${SCRIPT_DIR}/../../frontend" && pwd)"
FRONTEND_ENV="${FRONTEND_DIR}/.env"

# åŒæœŸå‰ã®ç¢ºèª
pre_sync_check() {
    log_section "åŒæœŸå‰ç¢ºèª"

    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª
    if [[ ! -d "$FRONTEND_DIR" ]]; then
        log_error "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${FRONTEND_DIR}"
        return 1
    fi

    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ .env ã®ç¢ºèªï¼ˆãªã‘ã‚Œã°è‡ªå‹•ç”Ÿæˆï¼‰
    if [[ ! -f "$FRONTEND_ENV" ]]; then
        log_warning "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ .env ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${FRONTEND_ENV}"
        log_info "ç¾è¡Œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«åˆã‚ã›ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ .env ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚"
        {
            echo "# Frontend environment (generated by sync-frontend-env)"
            echo "# Generated at: $(date '+%Y-%m-%d %H:%M:%S')"
            echo ""
            echo "# =========================================="
            echo "# Sui Contract Configuration"
            echo "# =========================================="
            echo "NEXT_PUBLIC_PACKAGE_ID="
            echo "NEXT_PUBLIC_PASSPORT_REGISTRY_ID="
            echo "NEXT_PUBLIC_ADMIN_CAP_ID="
            echo "NEXT_PUBLIC_UPGRADE_CAP_ID="
            echo ""
        } > "$FRONTEND_ENV" || {
            log_error "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ .env ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
            return 1
        }
        log_success "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ .env ã‚’ä½œæˆã—ã¾ã—ãŸã€‚"
    fi

    # å¥‘ç´„ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
    local contract_env=$(get_env_file_path "$SELECTED_NETWORK")
    if [[ ! -f "$contract_env" ]]; then
        log_error "å¥‘ç´„ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${contract_env}"
        log_info "å…ˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
        return 1
    fi

    # ç¾åœ¨ã®è¨­å®šã‚’è¡¨ç¤º
    echo "ğŸ“‹ åŒæœŸæƒ…å ±"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "  ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯: ${SELECTED_NETWORK}"
    echo "  å¥‘ç´„ç’°å¢ƒå¤‰æ•°: ${contract_env}"
    echo "  ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ${FRONTEND_ENV}"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo ""

    return 0
}

# Python3ã®å­˜åœ¨ç¢ºèª
check_python3() {
    if ! command -v python3 &> /dev/null; then
        log_error "python3 ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
        log_info "python3 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚"
        return 1
    fi
    return 0
}

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°ï¼ˆfrontend/.env ã®ã€ŒSui Contract Configurationã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã ã‘ã‚’åŒæœŸï¼‰
update_frontend_env() {
    local source_env=$(get_env_file_path "$SELECTED_NETWORK")
    local target_env="$FRONTEND_ENV"

    log_section "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒå¤‰æ•°ã®æ›´æ–°"

    log_info "ğŸ“ ç’°å¢ƒå¤‰æ•°ã‚’åŒæœŸã—ã¦ã„ã¾ã™..."
    log_info "ã‚½ãƒ¼ã‚¹: ${source_env}"
    log_info "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${target_env}"

    # Python3ã§ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°
    python3 - "$source_env" "$target_env" <<'PY'
import pathlib
import sys

CONTRACT_KEYS = [
    "PACKAGE_ID",
    "PASSPORT_REGISTRY_ID",
    "ADMIN_CAP_ID",
    "UPGRADE_CAP_ID",
]

def parse_env(path):
    data = {}
    for line in pathlib.Path(path).read_text().splitlines():
        stripped = line.strip()
        if not stripped or stripped.startswith('#'):
            continue
        if '=' not in stripped:
            continue
        key, value = stripped.split('=', 1)
        data[key.strip()] = value.strip()
    return data

src = parse_env(sys.argv[1])
dst_path = pathlib.Path(sys.argv[2])
dst_lines = dst_path.read_text().splitlines()

section_header = "# Sui Contract Configuration"
separator = "# =========================================="

def find_section(lines):
    header_idx = next((i for i, v in enumerate(lines) if v.strip() == section_header), None)
    if header_idx is None:
        return None, None

    start = header_idx + 1
    while start < len(lines) and (lines[start].strip() == "" or lines[start].lstrip().startswith('#')):
        start += 1

    end = start
    while end < len(lines) and not lines[end].startswith(separator):
        end += 1
    return start, end

start, end = find_section(dst_lines)

if start is None:
    # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ«å°¾ã«è¿½åŠ 
    dst_lines.extend([
        separator,
        section_header,
        separator,
    ])
    start = len(dst_lines)
    end = start

# æ—¢å­˜å€¤ã‚’è¨˜éŒ²ï¼ˆæ¬ ææ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
existing = {}
for line in dst_lines[start:end]:
    if '=' in line and not line.lstrip().startswith('#'):
        k, v = line.split('=', 1)
        existing[k.strip()] = v.strip()

new_section = []
changes = []

for key in CONTRACT_KEYS:
    target_key = f"NEXT_PUBLIC_{key}"
    if key in src:
        value = src[key]
    elif target_key in existing:
        value = existing[target_key]
    else:
        value = ""

    new_line = f"{target_key}={value}"
    old_line = existing.get(target_key)

    new_section.append(new_line)

    # å¤‰æ›´æ¤œçŸ¥ï¼ˆå€¤ãŒå­˜åœ¨ã—ãªã„å ´åˆã‚‚è¿½åŠ æ‰±ã„ï¼‰
    if old_line is None:
        changes.append((target_key, value, "è¿½åŠ "))
    elif old_line != value:
        changes.append((target_key, value, "æ›´æ–°"))

# ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›¸ãæ›ãˆã€å¥‘ç´„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç›´å¾Œã«ç©ºè¡Œã‚’å…¥ã‚Œã‚‹
dst_lines[start:end] = new_section + [""]

dst_path.write_text("\n".join(dst_lines) + "\n")

if changes:
    print("âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ .env ã‚’æ›´æ–°ã—ã¾ã—ãŸ:")
    for key, value, action in changes:
        display_value = value if len(value) <= 60 else f"{value[:60]}..."
        print(f"  [{action}] {key}={display_value}")
else:
    print("â„¹ï¸  Sui Contract Configuration ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æ›´æ–°ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")

sys.exit(0)
PY

    local exit_code=$?

    if [[ $exit_code -eq 0 ]]; then
        log_success "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒå¤‰æ•°ã®åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
        return 0
    else
        log_error "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒå¤‰æ•°ã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
        return 1
    fi
}

# åŒæœŸçµæœã®è¡¨ç¤º
show_sync_result() {
    log_section "åŒæœŸçµæœ"

    echo "ğŸ“„ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ .env ã® Sui Contract Configuration ã‚»ã‚¯ã‚·ãƒ§ãƒ³:"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    awk '
        $0=="# Sui Contract Configuration" {in_block=1; seen_sep=0; print; next}
        in_block && /^# ==========================================/ {
            if (seen_sep) {print; exit}
            seen_sep=1
            print
            next
        }
        in_block {print}
    ' "$FRONTEND_ENV" || echo "ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰"

    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo ""
    echo "ãƒ•ã‚¡ã‚¤ãƒ«: ${FRONTEND_ENV}"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    # Python3ã®ç¢ºèª
    if ! check_python3; then
        return 1
    fi

    # åŒæœŸå‰ç¢ºèª
    if ! pre_sync_check; then
        return 1
    fi

    # ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    if ! prompt_yes_no "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ .env ã‚’åŒæœŸã—ã¾ã™ã‹ï¼Ÿ" "y"; then
        log_info "åŒæœŸã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚"
        return 1
    fi

    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°
    if ! update_frontend_env; then
        return 1
    fi

    # åŒæœŸçµæœã‚’è¡¨ç¤º
    show_sync_result

    return 0
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œ
main
exit $?
